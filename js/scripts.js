!function(n){var e={};function t(r){if(e[r])return e[r].exports;var s=e[r]={i:r,l:!1,exports:{}};return n[r].call(s.exports,s,s.exports,t),s.l=!0,s.exports}t.m=n,t.c=e,t.d=function(n,e,r){t.o(n,e)||Object.defineProperty(n,e,{enumerable:!0,get:r})},t.r=function(n){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},t.t=function(n,e){if(1&e&&(n=t(n)),8&e)return n;if(4&e&&"object"==typeof n&&n&&n.__esModule)return n;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:n}),2&e&&"string"!=typeof n)for(var s in n)t.d(r,s,function(e){return n[e]}.bind(null,s));return r},t.n=function(n){var e=n&&n.__esModule?function(){return n.default}:function(){return n};return t.d(e,"a",e),e},t.o=function(n,e){return Object.prototype.hasOwnProperty.call(n,e)},t.p="js",t(t.s=0)}([function(module,__webpack_exports__,__webpack_require__){"use strict";eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _app_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(1);\n/* harmony import */ var _app_js__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(_app_js__WEBPACK_IMPORTED_MODULE_0__);\n\n\n//# sourceURL=webpack:///./src/js/index.js?")},function(module,exports){eval("(function initial() {\n  var init = false;\n  var usersOnlineArr = [];\n  var blockError = document.querySelector('.error');\n  var titleError = document.querySelector('.error__title');\n  var errorBtn = document.querySelector('.error__btn');\n  var usersList = document.querySelector('.participant');\n  var usersOnline = document.querySelector('.chat__participants');\n  var storage = localStorage;\n  var users = JSON.parse(storage.data || '[]');\n  var currentUser = {};\n  var socket = new WebSocket('ws://localhost:3000');\n  errorBtn.addEventListener('click', function () {\n    closeFade(blockError);\n  });\n\n  (function autorize() {\n    var app = document.querySelector('.app');\n    var autorizeBlock = document.querySelector('.authorisation');\n    var inputName = document.querySelector('#authorisation-name');\n    var inputNick = document.querySelector('#authorisation-nick');\n    var authForm = document.querySelector('.authorisation__form');\n    authForm.addEventListener('submit', function (e) {\n      e.preventDefault();\n      currentUser.name = inputName.value;\n      currentUser.nick = inputNick.value;\n      currentUser.type = 'userInfo';\n      currentUser.lastMes = '';\n      currentUser.img = '';\n      var _iteratorNormalCompletion = true;\n      var _didIteratorError = false;\n      var _iteratorError = undefined;\n\n      try {\n        for (var _iterator = users[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n          var user = _step.value;\n\n          if (inputName.value != user.name && inputNick.value === user.nick) {\n            titleError.textContent = 'Пользователь с таким ником уже существует';\n            openFade(blockError);\n            throw new Error('nick exists');\n          } else if (inputName.value == user.name && inputNick.value === user.nick) {\n            currentUser = user;\n          }\n        }\n      } catch (err) {\n        _didIteratorError = true;\n        _iteratorError = err;\n      } finally {\n        try {\n          if (!_iteratorNormalCompletion && _iterator[\"return\"] != null) {\n            _iterator[\"return\"]();\n          }\n        } finally {\n          if (_didIteratorError) {\n            throw _iteratorError;\n          }\n        }\n      }\n\n      if (inputName.value.length < 3 || inputNick.value.length < 3) {\n        titleError.textContent = 'Поля должны содержать не менее 3 символов';\n        openFade(blockError);\n      } else {\n        users.push(currentUser);\n        storage.data = JSON.stringify(users); // storage.data = '';\n\n        inputName.value = '';\n        inputNick.value = '';\n        autorizeBlock.style.display = 'none';\n        openFade(app);\n        init = true;\n\n        if (init === true) {\n          socket.send(JSON.stringify(currentUser));\n        }\n\n        init = false;\n      }\n    });\n  })();\n\n  socket.addEventListener('close', function () {\n    socket.send(JSON.stringify(currentUser)); // init = false;\n  });\n  socket.addEventListener('error', function () {\n    socket.send(JSON.stringify(currentUser)); // init = false;\n  });\n  socket.addEventListener('message', function (e) {\n    var users = JSON.parse(e.data);\n\n    function initPhoto() {\n      var asideAva = document.querySelector(\"#asideAva\".concat(currentUser.nick));\n\n      for (var key in users.users) {\n        if (currentUser.nick === users.users[key].nick) {\n          if (asideAva) {\n            asideAva.setAttribute('src', \"\".concat(users.users[key].img));\n          }\n        }\n      }\n    }\n\n    if (users.type == 'getAllUsers') {\n      // function inizialize() {\n      usersOnlineArr = [];\n      var onlineUsers = users.users;\n\n      for (var key in onlineUsers) {\n        if (onlineUsers) {\n          usersOnlineArr.push(onlineUsers[key]);\n          var usersItem = '';\n          usersOnlineArr.forEach(function (user) {\n            if (currentUser.nick === user.nick) {\n              user = currentUser;\n            }\n\n            usersItem += \"<li class=\\\"participant__item\\\">\\n                  <div class=\\\"participant__ava-wrap\\\">\\n                    <img class=\\\"participant__ava\\\" src=\\\"\".concat(user.img, \"\\\" id=\\\"asideAva\").concat(user.nick, \"\\\">\\n                    </div>\\n                  <div class=\\\"participant__info\\\">\\n                    <h3 class=\\\"participant__name\\\"> \").concat(user.name, \"</h3>\\n                    <div class=\\\"participant_mes\\\" id=\\\"lastmessage\").concat(user.nick, \"\\\"> \").concat(user.lastMes, \" </div>\\n                  </div>\\n                </li>\");\n          });\n          usersList.innerHTML = usersItem;\n          usersOnlineCount();\n          initPhoto();\n          initLastMessage();\n        }\n      }\n\n      if (currentUser.type == 'userSavePhoto') {\n        initPhoto();\n      }\n    } else {\n      addMes(users.lastMes, users.img, users.nick);\n      initChatAva();\n      initLastMessage();\n      initActiveMessage();\n    }\n  });\n\n  function addMes(mes, img, nick) {\n    var ChatList = document.querySelector('.chat__mes-list');\n    var date = new Date();\n    var hour = date.getHours();\n    var minutes = date.getMinutes();\n    var currentDate = \"\".concat(hour, \":\").concat(minutes);\n    var mesTemplate = \"\\n                    <div class=\\\"chat__ava-wrap\\\"><img class=\\\"chat__ava\\\" src=\\\"\".concat(img, \"\\\" id=\\\"chatAva\").concat(nick, \"\\\" ></div>\\n                  \\n                    <div class=\\\"chat__message\\\">\\n                    <span class=\\\"chat__text\\\"> \").concat(mes, \"</span>\\n                    <span class=\\\"chat__date\\\"> \").concat(currentDate, \" </span> </div>\");\n    var liMes = document.createElement('li');\n    liMes.classList.add('chat__messages');\n    liMes.classList.add(\"liMes\".concat(nick));\n    liMes.innerHTML = mesTemplate;\n    ChatList.appendChild(liMes);\n  }\n\n  function usersOnlineCount() {\n    var count = usersOnlineArr.length;\n    var end = '';\n\n    if (count > 10 && count < 20 || count >= 5) {\n      end = 'ов';\n    } else if (count >= 2 && count <= 4) {\n      end = 'a';\n    }\n\n    usersOnline.textContent = \"\".concat(count, \" \\u0443\\u0447\\u0430\\u0441\\u0442\\u043D\\u0438\\u043A\").concat(end);\n  }\n\n  (function openMenu() {\n    var menuBtn = document.querySelector('.aside__menu--btn');\n    var photoModal = document.querySelector('.photo__wrap--modal');\n    var photoModalName = document.querySelector('.photo__name');\n    var closeBtn = document.querySelector('.photo__modal-close');\n    menuBtn.addEventListener('click', function () {\n      openFade(photoModal);\n      photoModalName.textContent = currentUser.name;\n    });\n    closeBtn.addEventListener('click', function () {\n      closeFade(photoModal);\n    });\n  })();\n\n  (function loadPhoto() {\n    var inputLoad = document.querySelector('.photo__modal-wrap');\n    var modalPhoto = document.querySelector('.photo__wrap--modal');\n    var modalLoad = document.querySelector('.photo__wrap--load');\n    var cancelBtn = document.querySelector('#photo-cancel');\n    var loadBtn = document.querySelector('#photo-save');\n    var photoBlock = document.querySelector('.photo__load-ava');\n    var fileReader = new FileReader();\n    var photoSend;\n    var loaduserPhoto = document.querySelector('.photo__load-ava');\n    fileReader.addEventListener('load', function () {\n      photoBlock.src = fileReader.result;\n    });\n    inputLoad.addEventListener('change', function (e) {\n      closeFade(modalPhoto);\n      openFade(modalLoad);\n      var file = e.target.files[0];\n\n      if (file) {\n        if (file.size > 512 * 1024) {\n          openFade(blockError);\n          titleError.textContent = 'Слишком большой файл';\n        } else {\n          fileReader.readAsDataURL(file);\n        }\n      }\n    });\n    cancelBtn.addEventListener('click', function () {\n      closeFade(modalLoad);\n    });\n    loadBtn.addEventListener('click', function () {\n      var currentAva = document.querySelector(\"#asideAva\".concat(currentUser.nick));\n      photoSend = loaduserPhoto.getAttribute('src');\n      currentUser.img = photoSend;\n      currentUser.type = 'userSavePhoto';\n      socket.send(JSON.stringify(currentUser));\n      currentAva.setAttribute('src', currentUser.img);\n      initChatAva();\n      closeFade(modalLoad);\n    });\n  })();\n\n  (function sendMessage() {\n    var inputMes = document.querySelector('.chat__input');\n    var btnSend = document.querySelector('.chat__send-btn');\n    btnSend.addEventListener('click', function (e) {\n      e.preventDefault();\n\n      for (var _i = 0, _usersOnlineArr = usersOnlineArr; _i < _usersOnlineArr.length; _i++) {\n        var user = _usersOnlineArr[_i];\n\n        if (user.nick === currentUser.nick) {\n          currentUser = user;\n        }\n      }\n\n      currentUser.type = 'sendMessage';\n      currentUser.lastMes = inputMes.value;\n      socket.send(JSON.stringify(currentUser));\n      inputMes.value = '';\n      initLastMessage();\n    });\n  })();\n\n  function initChatAva() {\n    var thisAvas = document.querySelectorAll('.chat__ava');\n    var avaID;\n\n    if (thisAvas.length > 1) {\n      thisAvas.forEach(function (ava) {\n        avaID = ava.getAttribute('id');\n\n        for (var _i2 = 0, _usersOnlineArr2 = usersOnlineArr; _i2 < _usersOnlineArr2.length; _i2++) {\n          var user = _usersOnlineArr2[_i2];\n\n          if (avaID == \"chatAva\".concat(user.nick)) {\n            ava.setAttribute('src', user.img);\n          }\n        }\n      });\n    }\n\n    if (thisAvas.length === 1) {\n      avaID = thisAvas[0].getAttribute('id');\n\n      for (var _i3 = 0, _usersOnlineArr3 = usersOnlineArr; _i3 < _usersOnlineArr3.length; _i3++) {\n        var user = _usersOnlineArr3[_i3];\n\n        if (avaID == \"chatAva\".concat(user.nick)) {\n          thisAvas[0].setAttribute('src', user.img);\n        }\n      }\n    }\n  }\n\n  function initLastMessage() {\n    var lastMessages = document.querySelectorAll('.participant_mes');\n    var msgID;\n\n    if (lastMessages.length > 1) {\n      lastMessages.forEach(function (mes) {\n        msgID = mes.getAttribute('id');\n        usersOnlineArr.forEach(function (user) {\n          if (msgID == \"lastmessage\".concat(user.nick)) {\n            mes.textContent = user.lastMes;\n          }\n        });\n      });\n    }\n\n    if (lastMessages.length === 1) {\n      msgID = lastMessages[0].getAttribute('id');\n\n      for (var _i4 = 0, _usersOnlineArr4 = usersOnlineArr; _i4 < _usersOnlineArr4.length; _i4++) {\n        var user = _usersOnlineArr4[_i4];\n\n        if (msgID == \"lastmessage\".concat(user.nick)) {\n          lastMessages[0].textContent = user.lastMes;\n        }\n      }\n    }\n  }\n\n  function initActiveMessage() {\n    var messagesItem = document.querySelectorAll('.chat__messages');\n\n    if (messagesItem.length > 1) {\n      messagesItem.forEach(function (messageItem) {\n        if (messageItem.classList.contains(\"liMes\".concat(currentUser.nick))) {\n          messageItem.classList.add('active');\n        }\n      });\n    }\n\n    if (messagesItem.length === 1) {\n      if (messagesItem[0].classList.contains(\"liMes\".concat(currentUser.nick))) {\n        messagesItem[0].classList.add('active');\n      }\n    }\n  }\n\n  function openFade(modal) {\n    var opOpen = 0;\n    modal.style.display = 'flex';\n    modal.style.opacity = opOpen;\n    setTimeout(function fadeIn() {\n      opOpen += 0.1;\n\n      if (opOpen < 1) {\n        modal.style.opacity = opOpen;\n      }\n\n      setTimeout(fadeIn, 50);\n    }, 300);\n  }\n\n  function closeFade(modal) {\n    var opClose = 1;\n    setTimeout(function fadeOut() {\n      opClose -= 0.1;\n\n      if (opClose > 0) {\n        modal.style.opacity = opClose;\n        setTimeout(fadeOut, 50);\n      } else {\n        modal.style.display = 'none';\n      }\n    }, 300);\n  }\n})();\n\n//# sourceURL=webpack:///./src/js/app.js?")}]);